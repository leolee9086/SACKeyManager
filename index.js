const siyuan  = require('siyuan')
globalThis[Symbol.for(`clientApi`)]=globalThis[Symbol.for(`clientApi`)]||siyuan
const {Plugin} = siyuan
module.exports = class SACKeyManager extends Plugin{
    onload(){
        console.log('key管理器插件已经加载')
        this.初始化插件同步状态()
        this.初始化插件异步状态()
    }
    初始化插件同步状态(){
        this.插件自身工作空间路径 = `/data/plugins/${this.name}`
        this.插件自身数据存储路径 = `/data/storage/petal/${this.name}`
        this.工作空间根路径 = window.siyuan.config.system.workspaceDir
        this.插件自身伺服地址 = `/plugins/${this.name}`
        this.selfURL = this.插件自身伺服地址
        this.stayAlive = true
        this.创建key管理侧边栏()
        this.添加图标()
    }
    添加图标(){
        this.addIcons(
            `
            <symbol  id="iconBerry" viewBox='0 0 1024 1024'>
<path d="M868.352 635.904V386.048c34.304-6.144 61.952-38.4 61.952-74.752 0-42.496-34.304-74.752-74.752-74.752-21.504 0-42.496 10.752-55.296 25.6l-213.504-119.296c2.048-6.144 4.096-12.8 4.096-21.504 0-42.496-34.304-74.752-74.752-74.752s-74.752 34.304-74.752 74.752c0 6.144 2.048 12.8 2.048 19.456L230.4 262.656c-16.896-16.896-36.352-27.648-57.344-27.648-42.496 0-74.752 34.304-74.752 74.752 0 36.352 25.6 66.048 59.904 74.752v251.904c-34.304 8.704-59.904 38.4-59.904 74.752 0 42.496 34.304 74.752 74.752 74.752 21.504 0 42.496-10.752 55.296-25.6l215.552 119.296c-4.096 8.704-6.144 19.456-6.144 29.696 0 42.496 34.304 74.752 74.752 74.752s74.752-34.304 74.752-74.752c0-10.752-2.048-21.504-6.144-31.744l215.552-117.248c14.848 14.848 34.304 25.6 57.344 25.6 42.496 0 74.752-34.304 74.752-74.752 1.536-39.424-24.064-69.12-60.416-75.264z m-309.248 212.992c-8.704-6.144-16.896-10.752-25.6-12.8v-189.952h-36.352v189.952c-10.752 2.048-21.504 8.704-29.696 14.848l-219.648-121.856c2.048-6.144 2.048-12.8 2.048-19.456 0-34.304-23.552-64-55.296-72.704V384c12.8-4.096 23.552-8.704 31.744-19.456l159.744 98.304 19.456-29.696-160.256-98.304c2.048-8.704 4.096-14.848 4.096-23.552 0-6.144-2.048-12.8-2.048-19.456L460.8 170.496c12.8 14.848 34.304 23.552 55.296 23.552 21.504 0 40.448-8.704 53.248-23.552l213.504 121.856c-2.048 6.144-2.048 12.8-2.048 19.456 0 8.704 2.048 14.848 4.096 23.552l-159.744 98.304 19.456 29.696 157.696-96.256c8.704 8.704 19.456 14.848 31.744 19.456V640c-31.744 8.704-53.248 38.4-53.248 72.704 0 6.144 0 12.8 2.048 16.896l-223.744 119.296z" fill="#2B85FB" p-id="3731"></path><path d="M443.392 583.68c38.4 38.4 100.352 38.4 138.752 0s38.4-100.352 0-138.752-100.352-38.4-138.752 0c-38.4 37.888-38.4 100.352 0 138.752z"></path>
</symbol>

            <symbol id="iconKeyManage" class="icon" viewBox="0 0 240 240" >

            <g transform="matrix(0.776216,0,0,0.776216,57.13,56.3681)">
                <path d="M155.935,75.515C151.053,75.04 146.137,75.04 141.254,75.515L138.837,87.286C134.157,88.002 129.571,89.231 125.161,90.95L117.181,81.965C112.716,83.995 108.458,86.454 104.467,89.306L108.259,100.709C104.564,103.668 101.207,107.026 98.247,110.72L86.844,106.929C83.992,110.919 81.534,115.177 79.504,119.643L88.489,127.622C86.769,132.032 85.54,136.619 84.824,141.298L73.053,143.716C72.579,148.598 72.579,153.515 73.053,158.397L84.824,160.815C85.54,165.494 86.769,170.08 88.489,174.491L79.504,182.47C81.534,186.935 83.992,191.193 86.844,195.184L98.247,191.393C101.207,195.087 104.564,198.444 108.259,201.404L104.467,212.807C108.458,215.659 112.716,218.117 117.181,220.148L125.161,211.162C129.571,212.882 134.157,214.111 138.837,214.827L141.254,226.598C146.137,227.072 151.053,227.072 155.935,226.598L158.353,214.827C163.032,214.111 167.619,212.882 172.029,211.162L180.009,220.148C184.474,218.117 188.732,215.659 192.723,212.807L188.931,201.404C192.625,198.444 195.983,195.087 198.943,191.393L210.346,195.184C213.198,191.193 215.656,186.935 217.686,182.47L208.701,174.491C210.42,170.08 211.649,165.494 212.365,160.815L224.137,158.397C224.611,153.515 224.611,148.598 224.137,143.716L212.365,141.298C211.649,136.619 210.42,132.032 208.701,127.622L217.686,119.643C215.656,115.177 213.198,110.919 210.346,106.929L198.943,110.72C195.983,107.026 192.625,103.668 188.931,100.709L192.723,89.306C188.732,86.454 184.474,83.995 180.009,81.965L172.029,90.95C167.619,89.231 163.032,88.002 158.353,87.286L155.935,75.515ZM148.595,135.877C156.973,135.877 163.774,142.679 163.774,151.056C163.774,159.434 156.973,166.236 148.595,166.236C140.217,166.236 133.415,159.434 133.415,151.056C133.415,142.679 140.217,135.877 148.595,135.877Z" style="fill:none;stroke:black;stroke-width:4.91px;"/>
            </g>
            <g transform="matrix(1,0,0,1,5.90769,74.5026)">
                <circle cx="52.185" cy="101.251" r="41.846" style="fill:none;stroke:black;stroke-width:34.76px;"/>
            </g>
            <path d="M87.984,146.481L199.53,34.936" style="fill:none;stroke:black;stroke-width:28.66px;stroke-linecap:butt;"/>
            <path d="M118.136,116.33L145.723,143.918" style="fill:none;stroke:black;stroke-width:45.44px;stroke-linecap:butt;"/>
            <path d="M159.015,75.159L190.031,106.174" style="fill:none;stroke:black;stroke-width:45.44px;stroke-linecap:butt;"/>
        
        </symbol>`
        )
    }
    创建key管理侧边栏(){
        let that = this
        this.addDock(
            {
                config:{
                    icon:"iconKeyManage",
                    position:"LeftBottom",
                    size:{
                        width:200,
                        height:0
                    },
                    title:"SACKey管理"
                },
                init(){
                    that.mainDock=this
                    that.eventBus.emit('dock_main_inited')               
                }    
            },
        )
        const TAB_TYPE ='config-editor'
        this.configEditorTab = this.addTab({
            type:TAB_TYPE,
            init() {
                console.log(this)
                that.eventBus.emit('config-tab-inited',{tab:this,data:this.data});
            },
            beforeDestroy() {
                console.log("before destroy tab:", TAB_TYPE);
            },
            destroy() {
                console.log("destroy tab:", TAB_TYPE);
            }
        });
    }
    async 初始化插件异步状态(){
        this.设置管理器 = await import(this.插件自身伺服地址+`/source/data/index.js?t=${Date.now()}`)
        this.UI管理器= await import(this.插件自身伺服地址+`/source/UI/index.js?i=${Date.now()}`)
        if(this.mainDock){
            this.eventBus.emit('dock_main_inited')
        }
    }
}